{% extends "base.html" %} {% block atas7 %}Form Jovi{% endblock %} {% block
tengah7 %}
<h3 class="text-info mb-3">Form Data Pelanggan</h3>

<!-- FORM TAMBAH -->
<form id="userForm" method="POST" class="mb-4">
  <input
    type="text"
    name="nama"
    placeholder="Nama Pelanggan"
    class="form-control mb-2"
    required
  />
  <input
    type="text"
    name="alamat"
    placeholder="Alamat"
    class="form-control mb-2"
    required
  />
  <input
    type="text"
    name="telepon"
    placeholder="Telepon"
    class="form-control mb-2"
    required
  />
  <input
    type="email"
    name="email"
    placeholder="Email"
    class="form-control mb-3"
    required
  />
  <input
    type="number"
    name="jumlahpesanan"
    placeholder="Jumlah Pesanan"
    class="form-control mb-2"
    required
  />
  <button id="tombolsimpan" type="submit" class="btn btn-info">Tambah Pelanggan</button>
</form>

<!-- DATA PELANGGAN -->
<h5>Data Pelanggan:</h5>
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nama</th>
      <th>Alamat</th>
      <th>Telepon</th>
      <th>Email</th>
      <th>Jumlah Pesanan</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody>
    {% for p in data.data %}
    <tr id="row-{{ p.id }}">
      <td>{{ p.id }}</td>
      <td id="name-{{ p.id }}">{{ p.nama }}</td>
      <td id="addr-{{ p.id }}">{{ p.alamat }}</td>
      <td id="tel-{{ p.id }}">{{ p.telepon }}</td>
      <td id="email-{{ p.id }}">{{ p.email }}</td>
      <td id="jumlahpesanan-{{ p.id }}">{{ p.jumlahpesanan }}</td>
      <td>
        <button
          class="btn btn-sm btn-primary edit-btn"
          data-id="{{ p.id }}"
          data-nama="{{ p.nama }}"
          data-alamat="{{ p.alamat }}"
          data-telepon="{{ p.telepon }}"
          data-email="{{ p.email }}"
          data-jumlahpesanan="{{ p.jumlahpesanan }}"
        >
          Edit
        </button>

        <button class="delete-btn btn btn-sm btn-danger" data-id="{{ p.id }}">
          Hapus
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- FORM EDIT (sembunyi dulu) -->
<div id="editForm" style="display: none" class="card p-3 mt-4">
  <h3>Edit Data Pelanggan</h3>

  <label>Nama:</label>
  <input type="text" id="editName" class="form-control mb-2" />

  <label>Alamat:</label>
  <input type="text" id="editAddr" class="form-control mb-2" />

  <label>Telepon:</label>
  <input type="text" id="editTel" class="form-control mb-2" />

  <label>Email:</label>
  <input type="email" id="editEmail" class="form-control mb-3" />

  <label>Jumlah Pesanan:</label>
  <input type="text" id="editJumlahPesanan" class="form-control mb-2" />

  <button type="button" id="saveBtn" class="btn btn-success">Simpan</button>
  <button type="button" id="cancelBtn" class="btn btn-secondary">Batal</button>
</div>


<!-- jQuery untuk edit -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  $(document).ready(function () {
    const API_URL = "http://localhost:3000/pelanggan602";

    // Simpan Button Click
    $("#tombolsimpan").click(async function (e) {
      e.preventDefault();

      const form = document.getElementById("userForm");
      const data = Object.fromEntries(new FormData(form).entries());

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          alert("‚úÖ Data berhasil disimpan!");
          location.reload();
        } else {
          alert("‚ùå Gagal menyimpan data");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("‚ùå Error koneksi API");
      }
    });

    // Edit button click
    $(".edit-btn").click(function () {
      const id = $(this).data("id");
      $("#editName").val($(this).data("nama"));
      $("#editAddr").val($(this).data("alamat"));
      $("#editTel").val($(this).data("telepon"));
      $("#editEmail").val($(this).data("email"));
      $("#editJumlahPesanan").val($(this).data("jumlahpesanan"));
      $("#editForm").show();
      $("#saveBtn").data("id", id);
    });

    // Save button click
    $("#saveBtn").click(async function (e) {
      e.preventDefault();

      const id = $("#saveBtn").data("id");
      const data = {
        nama: $("#editName").val(),
        alamat: $("#editAddr").val(),
        telepon: $("#editTel").val(),
        email: $("#editEmail").val(),
        jumlahpesanan: $("#editJumlahPesanan").val(),
      };

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          alert("‚úÖ Data berhasil dirubah!");
          location.reload();
        } else {
          alert("‚ùå Gagal menyimpan data");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("‚ùå Error koneksi API");
      }
    });

    // Cancel button click
    $("#cancelBtn").click(function () {
      $("#editForm").hide();
    });

    // Delete button click
    $(".delete-btn").click(async function () {
      const id = $(this).data("id");

      if (!confirm("Yakin menghapus data ini?")) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
        });

        if (res.ok) {
          alert("üóëÔ∏è Data berhasil dihapus");
          setTimeout(() => location.reload(), 500);
        } else {
          alert("‚ùå Gagal menghapus data");
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Error koneksi API");
      }
    });
  });
</script>

{% endblock %} {% block bawah7 %}
<!-- üîπ Footer tetap di bawah -->
<footer class="bg-info text-white text-center py-3 mt-auto">
  <div class="container">
    <p class="mb-1 fw-bold">¬© 2025 Kelompok 7 - Atha & Jovi</p>
    <p class="mb-0">Sistem Pendataan Barang dan Pelanggan</p>
  </div>
</footer>

{% endblock %}
